/**
 * clouwaypush - 2016-01-15
 *
 * Copyright (c) 2016 clouWay ltd
 */
!function(a,b,c){b.module("clouway-push",[]).provider("pushApi",function(){this.subscriberLength=15,this.endpoints={serviceUrl:""},this.timeIntervals={keepAlive:60,channelReconnect:5},this.backendServiceUrl=function(a){return this.endpoints.serviceUrl=a,this},this.keepAliveTimeInterval=function(a){return this.timeIntervals.keepAlive=a,this},this.reconnectTimeInterval=function(a){return this.timeIntervals.channelReconnect=a,this},this.$get=["$rootScope","$interval","$timeout","$window","$http",function(a,c,d,e,f){var g,h,i=this.subscriberLength,j=this.timeIntervals,k=this.endpoints,l={},m=[],n={},o=function(a){for(var b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456",c=[],d=0;a>d;){d++;var e=Math.floor(Math.random()*b.length);c.push(b.charAt(e))}return c.join("")},p=function(a){var c=a.data,d=b.fromJson(c),e=l[d.event];b.forEach(e,function(a){a(d)})},q=function(a){var b=new goog.appengine.Channel(a),c=b.open();c.onmessage=p,c.onerror=function(a){u()}},r=function(a){var b=n.openConnection(),c={subscriber:b,eventName:a};k.serviceUrl&&""!==k.serviceUrl&&f.put(k.serviceUrl,"",{params:c}).then(function(a){})},s=function(a,b){var c={subscriber:g,eventName:a,correlationId:b};k.serviceUrl&&""!==k.serviceUrl&&f["delete"](k.serviceUrl,{params:c}).then(function(a){})},t=function(){var a={subscriber:g};f.post(k.serviceUrl,"",{params:a}).then(function(a){})},u=function(){var a={subscriber:g};f.get(k.serviceUrl,{params:a}).then(function(a){q(a.data),h||(h=c(t,1e3*j.keepAlive))},function(){d(u,1e3*j.channelReconnect,!0)})};return n.openConnection=function(a){return g?g:(a||(a=o(i)),g=a,u(a),a)},n.fireEvent=function(a,c){var d=b.extend({event:a},c);p({data:d})},n.bind=function(a,b){return n.bindId(a,"",b)},n.bindId=function(c,d,e){d||(d="");var f=c+d;b.isUndefined(l[f])&&(l[f]=[]);var g=function(b){e(b),a.$apply()};return r([f]),l[f].push(g),g},n.bulkBind=function(c,d,e){d||(d="");var f=c+d;b.isUndefined(l[f])&&(l[f]=[]);var g=function(b){e(b),a.$apply()};return m.push({eventKey:f,handler:e}),g},n.flushBulk=function(){if(m.length){var a=[];b.forEach(m,function(b){a.push(b.eventKey),l[b.eventKey].push(b.handler)}),r(a),m=[]}},n.isBulkPending=function(){return m.length>0},n.unbind=function(a,b){n.unbindId(a,"",b)},n.unbindId=function(a,c,d){c||(c="");var e=a+c;if(e in l){if(b.isUndefined(d))return s(a,c),void delete l[e];var f=l[e].indexOf(d);0>f||(l[e].splice(f,1),l[e].length||(s(a,c),delete l[e]))}},n}]}).config(["pushApiProvider",function(a){var b="/pushService",c=30,d=10;a.backendServiceUrl(b).keepAliveTimeInterval(c).reconnectTimeInterval(d)}])}(window,window.angular);