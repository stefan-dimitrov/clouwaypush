/**
 * clouwaypush - 2015-12-09
 *
 * Copyright (c) 2015 clouWay ltd
 */
!function(a,b,c){b.module("clouway-push",[]).provider("pushApi",function(){this.subscriberLength=15,this.connectionMethods={connect:b.noop,bind:b.noop,unbind:b.noop,keepAlive:b.noop},this.timeIntervals={keepAlive:60,channelReconnect:5},this.openConnectionMethod=function(a){return this.connectionMethods.connect=a,this},this.bindMethod=function(a){return this.connectionMethods.bind=a,this},this.unbindMethod=function(a){return this.connectionMethods.unbind=a,this},this.keepAliveMethod=function(a){return this.connectionMethods.keepAlive=a,this},this.keepAliveTimeInterval=function(a){return this.timeIntervals.keepAlive=a,this},this.reconnectTimeInterval=function(a){return this.timeIntervals.channelReconnect=a,this},this.$get=["$rootScope","$interval","$timeout","$window",function(a,c,d,e){var f,g,h=this.subscriberLength,i=this.connectionMethods,j=this.timeIntervals,k={},l={},m=function(a){for(var b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456",c=[],d=0;a>d;){d++;var e=Math.floor(Math.random()*b.length);c.push(b.charAt(e))}return c.join("")},n=function(a){var c=a.data,d=b.fromJson(c),e=k[d.event];b.forEach(e,function(a){a(d)})},o=function(a){var b=new goog.appengine.Channel(a),c=b.open();c.onmessage=n,c.onerror=function(a){s()}},p=function(a){var b=l.openConnection();i.bind(b,a)},q=function(a){i.unbind(f,a)},r=function(){i.keepAlive(f)},s=function(){i.connect(f).then(function(a){o(a),g=c(r,1e3*j.keepAlive)},function(){d(s,1e3*j.channelReconnect,!0)})};return l.openConnection=function(a){return f?f:(a||(a=m(h)),f=a,s(a),a)},l.bind=function(c,d){b.isUndefined(k[c])&&(k[c]=[]);var e=function(b){d(b),a.$apply()};return p(c),k[c].push(e),e},l.unbind=function(a,c){if(a in k){if(b.isUndefined(c))return q(a),void delete k[a];var d=k[a].indexOf(c);0>d||(k[a].splice(d,1),k[a].length||(q(a),delete k[a]))}},l}]}).config(["pushApiProvider",function(a){function c(a){var b=i.defer();return a.then(function(a){b.resolve(a.data)},function(a){b.reject(a.data)}),b.promise}var d="/pushService",e=30,f=10,g=b.injector(["ng"]),h=g.get("$http"),i=g.get("$q");a.keepAliveTimeInterval(e).reconnectTimeInterval(f).openConnectionMethod(function(a){var b={subscriber:a};return c(h.get(d,{params:b}))}).bindMethod(function(a,b){var e={subscriber:a,eventName:b};return c(h.put(d,"",{params:e}))}).unbindMethod(function(a,b){var e={subscriber:a,eventName:b};return c(h["delete"](d,{params:e}))}).keepAliveMethod(function(a){var b={subscriber:a};return c(h.post(d,"",{params:b}))})}])}(window,window.angular);